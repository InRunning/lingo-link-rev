# Lingo Link 翻译流程

## 1. 用户交互与文本选择

### 1.1 文本选择触发
- 用户在网页上选择文本 [`src/contentScript/lingoCard.tsx:146`](src/contentScript/lingoCard.tsx:146)
  - 监听 `mouseup` 事件，检测用户选择的文本
  - 如果用户选择了文本且设置了显示触发图标，则显示触发图标
  - 触发图标位置设置为鼠标释放位置

### 1.2 触发翻译
- 用户点击触发图标 [`src/contentScript/lingoCard.tsx:208`](src/contentScript/lingoCard.tsx:208)
  - 调用 `handleTriggerClick` 函数
  - 获取选中的文本和位置信息
  - 调用 `showCardAndPosition` 显示翻译卡片

### 1.3 快捷键翻译
- 用户设置快捷键后，可通过快捷键触发翻译 [`src/contentScript/lingoCard.tsx:130`](src/contentScript/lingoCard.tsx:130)
  - 使用 `hotkeys-js` 库监听快捷键
  - 快捷键触发时直接显示翻译卡片

## 2. 文本处理与上下文获取

### 2.1 获取选中文本
- 通过 `window.getSelection()` 获取用户选中的文本 [`src/utils/getSelection.ts:4`](src/utils/getSelection.ts:4)
- 处理特殊情况，如在输入框中的文本选择 [`src/utils/getSelection.ts:17`](src/utils/getSelection.ts:17)

### 2.2 获取句子上下文
- 调用 `getSentenceFromSelection` 获取包含选中文本的完整句子 [`src/utils/getSelection.ts:71`](src/utils/getSelection.ts:71)
  - 提取句子头部：`extractSentenceHead` [`src/utils/getSelection.ts:160`](src/utils/getSelection.ts:160)
  - 提取句子尾部：`extractSentenceTail` [`src/utils/getSelection.ts:181`](src/utils/getSelection.ts:181)
  - 合并形成完整句子上下文

### 2.3 判断文本类型
- 使用 `isWord` 函数判断选中的文本是单词还是句子 [`src/utils/index.ts:111`](src/utils/index.ts:111)
  - 使用 `Intl.Segmenter` 进行文本分词
  - 根据分词结果判断是单个单词还是句子

## 3. 翻译引擎选择与调用

### 3.1 获取用户设置
- 从 `settingAtom` 获取用户设置的翻译引擎 [`src/store.ts:17`](src/store.ts:17)
- 获取源语言和目标语言设置 [`src/utils/translate.ts:64`](src/utils/translate.ts:64)

### 3.2 调用翻译函数
- 调用 `translate` 函数进行翻译 [`src/utils/translate.ts:47`](src/utils/translate.ts:47)
  - 传入原始文本、翻译引擎和回调函数
  - 根据引擎类型选择不同的翻译实现

### 3.3 不同翻译引擎的实现

#### 3.3.1 Google 翻译
- 调用 `googleTranslate` 函数 [`src/api/google.ts:4`](src/api/google.ts:4)
  - 构建请求 URL：`https://translate.googleapis.com/translate_a/single`
  - 通过 `sendBackgroundFetch` 发送请求
  - 解析返回的 JSON 数据，提取翻译结果

#### 3.3.2 DeepLX 翻译
- 调用 `deepLXTranslate` 函数 [`src/api/deeplx.ts:6`](src/api/deeplx.ts:6)
  - 从用户设置中获取 DeepLX API 地址
  - 发送 POST 请求到 DeepLX 服务
  - 返回翻译结果

#### 3.3.3 有道翻译
- 调用 `youdaoTranslate` 函数 [`src/api/youdaoTranslate.ts:4`](src/api/youdaoTranslate.ts:4)
  - 构建有道翻译 URL：`https://www.youdao.com/result`
  - 获取 HTML 响应并解析
  - 使用 `parseYouDaoTranslateHTML` 提取翻译结果 [`src/api/youdaoTranslate.ts:39`](src/api/youdaoTranslate.ts:39)

#### 3.3.4 AI 翻译引擎
- 通过 `getChat` 函数获取对应的 AI 翻译类 [`src/api/chat.ts:9`](src/api/chat.ts:9)
  - 支持 OpenAI、Gemini、DeepSeek、文心一言等多种 AI 引擎
  - 构建预定义消息列表，包含系统提示和用户内容
  - 创建 AI 翻译实例并发送消息

### 3.4 AI 翻译引擎实现细节

#### 3.4.1 OpenAI 翻译
- 使用 `OpenAIClass` 类 [`src/api/openAI.tsx:20`](src/api/openAI.tsx:20)
  - 构建 OpenAI API 请求
  - 使用流式响应处理翻译结果
  - 通过 `handleStream` 处理返回的数据流 [`src/utils/index.ts:148`](src/utils/index.ts:148)

#### 3.4.2 DeepSeek 翻译
- 使用 `DeepSeekClass` 类 [`src/api/deepSeek.tsx:19`](src/api/deepSeek.tsx:19)
  - 构建 DeepSeek API 请求
  - 使用流式响应处理翻译结果
  - 处理方式与 OpenAI 类似

#### 3.4.3 Gemini 翻译
- 使用 `GeminiClass` 类 [`src/api/gemini.ts:40`](src/api/gemini.ts:40)
  - 构建 Gemini API 请求
  - 使用特殊的 JSON 解析方式处理响应
  - 通过 `tryParse` 函数解析流式响应 [`src/api/gemini.ts:6`](src/api/gemini.ts:6)

## 4. 翻译结果展示

### 4.1 翻译卡片显示
- 在 `SearchResult` 组件中显示翻译结果 [`src/components/SearchResult.tsx`](src/components/SearchResult.tsx)
- 使用 `Translate` 组件处理翻译逻辑和显示 [`src/components/Translate.tsx:18`](src/components/Translate.tsx:18)
  - 显示加载状态
  - 显示翻译结果
  - 提供收藏、掌握、笔记等功能按钮

### 4.2 翻译结果处理
- 处理翻译过程中的不同状态 [`src/components/Translate.tsx:58`](src/components/Translate.tsx:58)
  - `beforeRequest`: 开始请求前的处理
  - `onGenerating`: 翻译过程中的实时更新
  - `onSuccess`: 翻译成功后的处理
  - `onError`: 翻译出错的处理

### 4.3 附加功能
- 发音功能：使用 `YoudaoSpeaker` 组件提供单词发音 [`src/components/Speaker.tsx`](src/components/Speaker.tsx)
- 收藏功能：将单词添加到生词本
- 笔记功能：为单词添加笔记
- 上下文显示：显示包含单词的原始句子

## 5. 后台服务与网络请求

### 5.1 后台请求处理
- 在 `background.ts` 中处理后台请求 [`src/background.ts:17`](src/background.ts:17)
  - 实现 `backgroundFetch` 函数处理网络请求
  - 支持不同的响应类型：text、json、dataURL

### 5.2 上下文菜单集成
- 注册右键菜单 "translate" [`src/background.ts:51`](src/background.ts:51)
  - 在选中文本时显示翻译选项
  - 点击后触发翻译卡片显示

### 5.3 跨域请求处理
- 通过后台脚本处理跨域请求
- 使用 `sendBackgroundFetch` 发送需要跨域的请求 [`src/utils/index.ts:102`](src/utils/index.ts:102)

## 6. 国际化支持

### 6.1 多语言配置
- 使用 `i18next` 进行国际化管理 [`src/i18n.ts:1`](src/i18n.ts:1)
- 支持中文和英文界面语言
- 在 `resources` 对象中定义各语言的翻译文本

### 6.2 语言检测
- 支持自动检测源语言
- 使用百度语言检测 API [`src/api/index.ts:95`](src/api/index.ts:95)
- 根据检测结果调整翻译参数

### 6.3 语言设置
- 用户可以设置源语言和目标语言
- 支持多种语言对之间的翻译
- 设置保存在浏览器的同步存储中

## 7. 数据存储与管理

### 7.1 设置存储
- 使用 `sync` 存储保存用户设置 [`src/storage/sync.ts`](src/storage/sync.ts)
- 包括翻译引擎、语言设置、API 密钥等

### 7.2 本地数据存储
- 使用 `local` 存储保存本地数据 [`src/storage/local.ts`](src/storage/local.ts)
- 包括生词列表、笔记列表等

### 7.3 状态管理
- 使用 `jotai` 进行状态管理 [`src/store.ts:1`](src/store.ts:1)
- 管理设置、生词列表、笔记列表等状态
- 提供添加、删除、更新等操作

## 8. 扩展功能

### 8.1 欧路词典集成
- 支持与欧路词典同步 [`src/api/oulu.ts`](src/api/oulu.ts)
- 添加单词到欧路词典学习列表
- 从欧路词典获取学习数据

### 8.2 截图翻译
- 支持截图翻译功能 [`src/utils/index.ts:233`](src/utils/index.ts:233)
- 使用浏览器扩展 API 截取当前页面
- 发送截图进行 OCR 识别和翻译

### 8.3 外部链接
- 支持自定义外部翻译链接 [`src/utils/const.ts:94`](src/utils/const.ts:94)
- 可以添加其他翻译服务的链接
- 支持参数替换，如 `{text}` 替换为实际文本

## 总结

Lingo Link 是一个功能丰富的浏览器扩展翻译工具，支持多种翻译引擎和翻译方式。从用户选择文本到显示翻译结果，整个流程涉及文本处理、翻译引擎调用、结果展示等多个环节。项目采用模块化设计，各功能模块职责明确，便于维护和扩展。通过支持多种翻译引擎和丰富的附加功能，为用户提供了全面的翻译体验。