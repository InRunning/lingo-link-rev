# Lingo Link 浏览器扩展项目 - 初始化流程与执行流程

## 项目概述
Lingo Link 是一个功能丰富的浏览器扩展，提供划词翻译、生词本管理、多引擎翻译支持等功能。项目基于 TypeScript + React + Vite 构建，支持 Chrome、Firefox、Edge 等多个浏览器平台。

## 初始化流程

### 1. 在 [manifest.config.ts#L51](../manifest.config.ts#L51) 调用 `Browser.runtime.onInstalled.addListener` [manifest.config.ts#L51](../manifest.config.ts#L51)
   1.1 在 [manifest.config.ts#L52](../manifest.config.ts#L52) 调用 `Browser.contextMenus.create` [manifest.config.ts#L52](../manifest.config.ts#L52)
   1.2 在 [manifest.config.ts#L64](../manifest.config.ts#L64) 调用 `Browser.contextMenus.onClicked.addListener` [manifest.config.ts#L64](../manifest.config.ts#L64)

### 2. 在 [src/contentScript/index.tsx#L12](../src/contentScript/index.tsx#L12) 调用 `LingoLink` 构造函数 [src/contentScript/index.tsx#L12](../src/contentScript/index.tsx#L12)
   2.1 在 [src/contentScript/index.tsx#L15](../src/contentScript/index.tsx#L15) 调用 `attachShadow` [src/contentScript/index.tsx#L15](../src/contentScript/index.tsx#L15)
   2.2 在 [src/contentScript/index.tsx#L33](../src/contentScript/index.tsx#L33) 调用 `ReactDOM.createRoot` [src/contentScript/index.tsx#L33](../src/contentScript/index.tsx#L33)
   2.3 在 [src/contentScript/index.tsx#L41](../src/contentScript/index.tsx#L41) 调用 `customElements.define` [src/contentScript/index.tsx#L41](../src/contentScript/index.tsx#L41)
   2.4 在 [src/contentScript/index.tsx#L45](../src/contentScript/index.tsx#L45) 调用 `genHighlightStyle` [src/contentScript/highlightStyle.tsx](../src/contentScript/highlightStyle.tsx)

### 3. 在 [src/i18n.ts#L178](../src/i18n.ts#L178) 调用 `i18n.use` [../src/i18n.ts#L178](../src/i18n.ts#L178)
   3.1 在 [src/i18n.ts#L179](../src/i18n.ts#L179) 调用 `LanguageDetector` [../src/i18n.ts#L179](../src/i18n.ts#L179)
   3.2 在 [src/i18n.ts#L180](../src/i18n.ts#L180) 调用 `initReactI18next` [../src/i18n.ts#L180](../src/i18n.ts#L180)
   3.3 在 [src/i18n.ts#L181](../src/i18n.ts#L181) 调用 `i18n.init` [../src/i18n.ts#L181](../src/i18n.ts#L181)

### 4. 在 [src/store.ts#L10](../src/store.ts#L10) 调用 `atom` 创建状态 [src/store.ts#L10](../src/store.ts#L10)
   4.1 在 [src/store.ts#L11](../src/store.ts#L11) 调用 `swwListAtom` [src/store.ts#L11](../src/store.ts#L11)
   4.2 在 [src/store.ts#L17](../src/store.ts#L17) 调用 `settingAtom` [src/store.ts#L17](../src/store.ts#L17)
   4.3 在 [src/store.ts#L25](../src/store.ts#L25) 调用 `settingAtom.onMount` [src/store.ts#L25](../src/store.ts#L25)
   4.4 在 [src/store.ts#L26](../src/store.ts#L26) 调用 `getSettingStorage` [src/storage/sync.ts#L3](../src/storage/sync.ts#L3)

### 5. 在 [src/storage/sync.ts#L3](../src/storage/sync.ts#L3) 调用 `getSetting` [src/storage/sync.ts#L3](../src/storage/sync.ts#L3)
   5.1 在 [src/storage/sync.ts#L6](../src/storage/sync.ts#L6) 调用 `setSetting` [src/storage/sync.ts#L6](../src/storage/sync.ts#L6)
   5.2 在 [src/storage/sync.ts#L9](../src/storage/sync.ts#L9) 调用 `clearSetting` [src/storage/sync.ts#L9](../src/storage/sync.ts#L9)

## 执行流程

### 1. 用户交互触发流程

#### 1.1 在 [src/contentScript/lingoCard.tsx#L146](../src/contentScript/lingoCard.tsx#L146) 调用 `handleMouseUp` [src/contentScript/lingoCard.tsx#L146](src/contentScript/lingoCard.tsx#L146)
   1.1.1 在 [src/contentScript/lingoCard.tsx#L150](src/contentScript/lingoCard.tsx#L150) 调用 `window.getSelection()` [src/contentScript/lingoCard.tsx#L150](src/contentScript/lingoCard.tsx#L150)
   1.1.2 在 [src/contentScript/lingoCard.tsx#L183](src/contentScript/lingoCard.tsx#L183) 调用 `currentSelectionInfo.word` [src/contentScript/lingoCard.tsx#L183](src/contentScript/lingoCard.tsx#L183)
   1.1.3 在 [src/contentScript/lingoCard.tsx#L184](src/contentScript/lingoCard.tsx#L184) 调用 `getSentenceFromSelection` [src/utils/getSelection.ts](src/utils/getSelection.ts)
   1.1.4 在 [src/contentScript/lingoCard.tsx#L187](src/contentScript/lingoCard.tsx#L187) 调用 `window.getSelection().getRangeAt(0)` [src/contentScript/lingoCard.tsx#L187](src/contentScript/lingoCard.tsx#L187)

#### 1.2 在 [src/background.ts#L64](src/background.ts#L64) 调用 `Browser.contextMenus.onClicked.addListener` [src/background.ts#L64](src/background.ts#L64)
   1.2.1 在 [src/background.ts#L69](src/background.ts#L69) 调用 `Browser.tabs.sendMessage` [src/background.ts#L69](src/background.ts#L69)
   1.2.2 在 [src/contentScript/lingoCard.tsx#L226](src/contentScript/lingoCard.tsx#L226) 调用 `handleMessage` [src/contentScript/lingoCard.tsx#L226](src/contentScript/lingoCard.tsx#L226)

#### 1.3 在 [src/contentScript/lingoCard.tsx#L129](src/contentScript/lingoCard.tsx#L129) 调用 `hotkeys` [src/contentScript/lingoCard.tsx#L129](src/contentScript/lingoCard.tsx#L129)
   1.3.1 在 [src/contentScript/lingoCard.tsx#L131](src/contentScript/lingoCard.tsx#L131) 调用 `showCardAndPosition` [src/contentScript/lingoCard.tsx#L60](src/contentScript/lingoCard.tsx#L60)
   1.3.2 在 [src/contentScript/lingoCard.tsx#L132](src/contentScript/lingoCard.tsx#L132) 调用 `currentSelectionInfo.word` [src/contentScript/lingoCard.tsx#L132](src/contentScript/lingoCard.tsx#L132)

### 2. 翻译卡片显示流程

#### 2.1 在 [src/contentScript/lingoCard.tsx#L60](src/contentScript/lingoCard.tsx#L60) 调用 `showCardAndPosition` [src/contentScript/lingoCard.tsx#L60](src/contentScript/lingoCard.tsx#L60)
   2.1.1 在 [src/contentScript/lingoCard.tsx#L70](src/contentScript/lingoCard.tsx#L70) 调用 `setCardShow(true)` [src/contentScript/lingoCard.tsx#L70](src/contentScript/lingoCard.tsx#L70)
   2.1.2 在 [src/contentScript/lingoCard.tsx#L71](src/contentScript/lingoCard.tsx#L71) 调用 `setSearchText(text)` [src/contentScript/lingoCard.tsx#L71](src/contentScript/lingoCard.tsx#L71)
   2.1.3 在 [src/contentScript/lingoCard.tsx#L76](src/contentScript/lingoCard.tsx#L76) 调用 `preventBeyondWindow` [src/utils/index.ts#L13](src/utils/index.ts#L13)
   2.1.4 在 [src/contentScript/lingoCard.tsx#L92](src/contentScript/lingoCard.tsx#L92) 调用 `setCardPosition` [src/contentScript/lingoCard.tsx#L92](src/contentScript/lingoCard.tsx#L92)

#### 2.2 在 [src/components/Translate.tsx#L58](src/components/Translate.tsx#L58) 调用 `translate` [src/utils/translate.ts](src/utils/translate.ts)
   2.2.1 在 [src/components/Translate.tsx#L63](src/components/Translate.tsx#L63) 调用 `beforeRequest()` [src/components/Translate.tsx#L63](src/components/Translate.tsx#L63)
   2.2.2 在 [src/components/Translate.tsx#L71](src/components/Translate.tsx#L71) 调用 `onGenerating(result)` [src/components/Translate.tsx#L71](src/components/Translate.tsx#L71)
   2.2.3 在 [src/components/Translate.tsx#L79](src/components/Translate.tsx#L79) 调用 `onSuccess(result, messageList)` [src/components/Translate.tsx#L79](src/components/Translate.tsx#L79)

#### 2.3 在 [src/utils/translate.ts](../src/utils/translate.ts) 调用翻译引擎
   2.3.1 在 [src/api/google.ts](../src/api/google.ts) 调用 Google 翻译 API
   2.3.2 在 [src/api/youdaoTranslate.ts](../src/api/youdaoTranslate.ts) 调用有道翻译 API
   2.3.3 在 [src/api/deepSeek.tsx](../src/api/deepSeek.tsx) 调用 DeepSeek 翻译 API
   2.3.4 在 [src/api/gemini.ts](../src/api/gemini.ts) 调用 Gemini 翻译 API

### 3. 弹窗界面执行流程

#### 3.1 在 [src/pages/popup/main.tsx#L22](../src/pages/popup/main.tsx#L22) 调用 `App` 函数 [src/pages/popup/main.tsx#L22](../src/pages/popup/main.tsx#L22)
   3.1.1 在 [src/pages/popup/main.tsx#L47](../src/pages/popup/main.tsx#L47) 调用 `getSetting()` [src/storage/sync.ts#L3](../src/storage/sync.ts#L3)
   3.1.2 在 [src/pages/popup/main.tsx#L52](../src/pages/popup/main.tsx#L52) 调用 `i18n.changeLanguage` [src/pages/popup/main.tsx#L52](../src/pages/popup/main.tsx#L52)
   3.1.3 在 [src/pages/popup/main.tsx#L65](../src/pages/popup/main.tsx#L65) 调用 `PopupInput` [src/components/PopupInput.tsx](../src/components/PopupInput.tsx)
   3.1.4 在 [src/pages/popup/main.tsx#L67](../src/pages/popup/main.tsx#L67) 调用 `SearchResult` [src/components/SearchResult.tsx](../src/components/SearchResult.tsx)
   3.1.5 在 [src/pages/popup/main.tsx#L70](../src/pages/popup/main.tsx#L70) 调用 `PopupFooter` [src/pages/popup/footer.tsx](../src/pages/popup/footer.tsx)
   3.1.6 在 [src/pages/popup/main.tsx#L96](../src/pages/popup/main.tsx#L96) 调用 `createRoot` [src/pages/popup/main.tsx#L96](../src/pages/popup/main.tsx#L96)

#### 3.2 在 [src/pages/options/main.tsx#L26](../src/pages/options/main.tsx#L26) 调用 `App` 函数 [src/pages/options/main.tsx#L26](../src/pages/options/main.tsx#L26)
   3.2.1 在 [src/pages/options/main.tsx#L89](../src/pages/options/main.tsx#L89) 调用 `useEffect` 监听 hash 变化 [src/pages/options/main.tsx#L89](../src/pages/options/main.tsx#L89)
   3.2.2 在 [src/pages/options/main.tsx#L104](../src/pages/options/main.tsx#L104) 调用 `onMenuClick` [src/pages/options/main.tsx#L104](../src/pages/options/main.tsx#L104)
   3.2.3 在 [src/pages/options/main.tsx#L133](../src/pages/options/main.tsx#L133) 调用 `Sidebar` [src/pages/options/sidebar.tsx](../src/pages/options/sidebar.tsx)
   3.2.4 在 [src/pages/options/main.tsx#L143](../src/pages/options/main.tsx#L143) 渲染对应的设置页面组件

### 4. 数据同步流程

#### 4.1 在 [src/store.ts#L30](../src/store.ts#L30) 调用 `addSwwAtom` [src/store.ts#L30](../src/store.ts#L30)
   4.1.1 在 [src/store.ts#L32](../src/store.ts#L32) 调用 `removeSwwAtom` [src/store.ts#L32](../src/store.ts#L32)
   4.1.2 在 [src/store.ts#L34](../src/store.ts#L34) 调用 `updateSwwItemAtom` [src/store.ts#L34](../src/store.ts#L34)
   4.1.3 在 [src/store.ts#L36](../src/store.ts#L36) 调用 `syncToServer` [src/store.ts#L36](../src/store.ts#L36)
   4.1.4 在 [src/store.ts#L38](../src/store.ts#L38) 调用 `updateLocalStorage` [src/store.ts#L38](../src/store.ts#L38)
   4.1.5 在 [src/store.ts#L40](../src/store.ts#L40) 调用 `updateEudicSync` [src/store.ts#L40](../src/store.ts#L40)

#### 4.2 在 [src/store.ts#L17](../src/store.ts#L17) 调用 `settingAtom` [src/store.ts#L17](../src/store.ts#L17)
   4.2.1 在 [src/store.ts#L19](../src/store.ts#L19) 调用 `setSettingStorage` [src/storage/sync.ts#L6](../src/storage/sync.ts#L6)
   4.2.2 在 [src/store.ts#L21](../src/store.ts#L21) 调用 `Browser.storage.sync.set` [src/store.ts#L21](../src/store.ts#L21)
   4.2.3 在 [src/store.ts#L23](../src/store.ts#L23) 调用 `persistUserConfig` [src/store.ts#L23](../src/store.ts#L23)

### 5. 消息传递流程

#### 5.1 在 [src/background.ts#L75](../src/background.ts#L75) 调用 `Browser.runtime.onMessage.addListener` [src/background.ts#L75](../src/background.ts#L75)
   5.1.1 在 [src/background.ts#L78](../src/background.ts#L78) 调用 `handleFetch` [src/background.ts#L78](../src/background.ts#L78)
   5.1.2 在 [src/background.ts#L81](../src/background.ts#L81) 调用 `handleOpenOptions` [src/background.ts#L81](../src/background.ts#L81)
   5.1.3 在 [src/background.ts#L84](../src/background.ts#L84) 调用 `handleAuth` [src/background.ts#L84](../src/background.ts#L84)
   5.1.4 在 [src/background.ts#L87](../src/background.ts#L87) 调用 `handleCaptureScreen` [src/background.ts#L87](../src/background.ts#L87)
   5.1.5 在 [src/background.ts#L90](../src/background.ts#L90) 调用 `handleExternalMessage` [src/background.ts#L90](../src/background.ts#L90)

#### 5.2 在 [src/contentScript/lingoCard.tsx#L225](../src/contentScript/lingoCard.tsx#L225) 调用 `Browser.runtime.onMessage.addListener` [src/contentScript/lingoCard.tsx#L225](../src/contentScript/lingoCard.tsx#L225)
   5.2.1 在 [src/contentScript/lingoCard.tsx#L228](../src/contentScript/lingoCard.tsx#L228) 调用 `handleShowCardAndPosition` [src/contentScript/lingoCard.tsx#L228](../src/contentScript/lingoCard.tsx#L228)
   5.2.2 在 [src/contentScript/lingoCard.tsx#L231](../src/contentScript/lingoCard.tsx#L231) 调用 `handleOnScreenDataurl` [src/contentScript/lingoCard.tsx#L231](../src/contentScript/lingoCard.tsx#L231)
   5.2.3 在 [src/contentScript/lingoCard.tsx#L234](../src/contentScript/lingoCard.tsx#L234) 调用 `handleGetCurWindowSelectionInfo` [src/contentScript/lingoCard.tsx#L234](../src/contentScript/lingoCard.tsx#L234)
   5.2.4 在 [src/contentScript/lingoCard.tsx#L237](../src/contentScript/lingoCard.tsx#L237) 调用 `handleOtherMessages` [src/contentScript/lingoCard.tsx#L237](../src/contentScript/lingoCard.tsx#L237)

## 关键特性

1. **多引擎支持**: 集成 Google、Youdao、DeepSeek、Gemini 等多种翻译引擎
2. **生词本管理**: 支持本地存储和云端同步
3. **划词翻译**: 支持鼠标划词、右键菜单、快捷键多种触发方式
4. **国际化**: 支持中英文界面切换
5. **响应式设计**: 自适应不同页面布局
6. **错误处理**: 完善的错误边界和异常处理机制

这个项目展现了一个现代化浏览器扩展的完整架构，从初始化到用户交互，从数据处理到界面渲染，形成了完整的闭环流程。